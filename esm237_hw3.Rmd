---
title: "ESM237 HW3"
author: "Alex Ehrens, Claudia Flores, Bobby Miyashiro"
date: "5/12/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# packages
library(tidyverse)
library(lubridate)
library(janitor)
```

### Read in and tidy climate data
```{r}
# read in climate datasets
data_45 <- read.csv("data/seattle_gfdl_rcp45.csv", skip = 10, header = TRUE)

data_85 <- read.csv("data/seattle_gfdl_rcp85.csv", skip = 10, header = TRUE)

data_projections <- read.csv("data/hdd_cdd_projections.csv") %>% 
  clean_names()

# parse dates, rename columns, convert from Kelvin to celsius
data_45 <- data_45 %>% 
  rename("date" = "yyyy.mm.dd", "tmax" = "tasmax_GFDL.ESM2M_rcp45.K.", "tmin" = "tasmin_GFDL.ESM2M_rcp45.K.") %>% 
  mutate(date = as.Date(date)) %>% 
  mutate(tmax = tmax - 273.15) %>% 
  mutate(tmin = tmin - 273.15)

data_85 <- data_85 %>% 
  rename("date" = "yyyy.mm.dd", "tmax" = "tasmax_GFDL.ESM2M_rcp85.K.", "tmin" = "tasmin_GFDL.ESM2M_rcp85.K.") %>% 
  mutate(date = as.Date(date)) %>% 
  mutate(tmax = tmax - 273.15) %>% 
  mutate(tmin = tmin - 273.15)
```

### Run function containing equations from Hamlet et al
```{r}
source("cdd_fun.R")

# input Seattle's population (as of 2019)
pop = 724305 

# run Hamlet function using climate data as tmax and tmin inputs 
results_45 <- Hamlet(data_45, pop)

results_85 <- Hamlet(data_85, pop)

# run Hamlet equation for HEDI and CEDI for projections
results_proj <- data_projections %>% 
  mutate(ac_pen = 0.944-(1.17*exp(-0.00298*cooling_degree_days))) %>% 
    mutate(ac_pen = case_when(
      ac_pen > 0.08 ~ ac_pen,
      ac_pen < 0.08 ~ 0.08)) %>% 
  mutate(CEDI = ac_pen*pop*cooling_degree_days) %>% 
  mutate(HEDI = pop*heating_degree_days)
```

### Make some plots
```{r}
### rcp4.5 plots
# cdd
ggplot(data = results_45) +
  geom_line(aes(x = year, y = cdd))

# hdd 
ggplot(data = results_45)+
  geom_line(aes(x = year, y = hdd))

# CEDI
ggplot(data = results_45)+
  geom_line(aes(x = year, y = CEDI))

# HEDI
ggplot(data = results_45)+
  geom_line(aes(x = year, y = HEDI))

### rcp8.5 plots
# cdd
ggplot(data = results_85) +
  geom_line(aes(x = year, y = cdd))

# hdd 
ggplot(data = results_85)+
  geom_line(aes(x = year, y = hdd))

# CEDI
ggplot(data = results_85)+
  geom_line(aes(x = year, y = CEDI))

# HEDI
ggplot(data = results_85)+
  geom_line(aes(x = year, y = HEDI))

### projection plots
# CEDI
ggplot(data = results_proj)+
  geom_line(aes(x = year, y = CEDI))

# HEDI
ggplot(data = results_proj)+
  geom_line(aes(x = year, y = HEDI))
```

